<!DOCTYPE html>
<html>
<body>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.slim.min.js"></script>

<h1>Here's a Plotly graph!</h1>
{{ fig }}


<div id="plot-0" class="toshow" style="display:none">
{{ figures[0]|safe }} 
</div>

<div id="plot-1" class="toshow" style="display:none">
{{ figures[1]|safe }} 
</div>

<script>
    
    var lodCutoff = {{ lodCutoff }};
    var fig = document.getElementById('plotDiv');

    fig.on('plotly_click', function(data){  
        console.log(data);
        var txt = data.points[0].data.customdata[0]["Image"];
        alert('Clicked point: '+ txt);
        /*
        var pts = '';
        for(var i=0; i < data.points.length; i++){
        pts = 'x = '+data.points[i].x +'\ny = '+
            data.points[i].y.toPrecision(4) + '\n\n';
        }
    alert('Closest point clicked:\n\n'+pts);
    */
    });


    function handleZoomEvent(eventdata)
    {
        //var fig = document.getElementById('plotDiv');
        console.log(eventdata);
        if (!('xaxis.autorange' in eventdata))
        {
            // There are also 2 other events, one for only x-axis and one for only y-axis
            if (('xaxis.range[0]' in eventdata) && ('yaxis.range[0]' in eventdata))
            {
                var x_min = eventdata['xaxis.range[0]'];
                var x_max = eventdata['xaxis.range[1]'];
                var x_delta = x_max - x_min;
                var lodLevel = Math.floor(x_delta / lodCutoff);
                var newPlot = "plot-" + lodLevel;
                //var figure = document.getElementById(newPlot).innerHTML;
                //var figure = figs[lodLevel];
                //var actual = figure[lodLevel]
                console.log(newPlot);
                /*
                alert( 'ZOOM!' + '\n\n' +
                    'Event data:' + '\n' +
                    JSON.stringify(eventdata) + '\n\n' +
                    'x-axis start:' + eventdata['xaxis.range[0]'] + '\n' +
                    'x-axis end:' + eventdata['xaxis.range[1]'] + "\n" + 
                    'LOD level:' + lodLevel);
                */
                var figure = JSON.parse(document.getElementById(newPlot).innerHTML);
                Plotly.react("plotDiv", figure.data, figure.layout);
                Plotly.relayout("plotDiv", 'xaxis.range', [x_min, x_max]);
                Plotly.relayout("plotDiv", 'yaxis.range', [eventdata['yaxis.range[0]'], eventdata['yaxis.range[1]']]);

            }
            
        }
        else
        {
            /*
            alert( 'ZOOM RESET!' + '\n\n' +
                'Event data:' + '\n' +
                JSON.stringify(eventdata));
            */
            var newPlot = "plot-1";
            var figure = JSON.parse(document.getElementById(newPlot).innerHTML);
            Plotly.react("plotDiv", figure.data, figure.layout);
        }        


    }

    fig.on('plotly_hover', function(data){ 
        console.log(data);
        var customdata = data.points[0].data.customdata[0];
        console.log(typeof(customdata));
        if (typeof(customdata) == "object" && "Graph" in customdata)
        {
            if (customdata["Graph"] == 1)
            {
                var color = data.points[0].fullData.fillcolor.split(",");
                console.log(color);
                var r = color[0];
                var g = color[1];
                var b = color[2];
                var finalColor = r + "," + g + "," + b + ", 1.0)";
                console.log(finalColor);
                console.log(customdata)
                var x_pos = Math.round(data.points[0].bbox["x1"]) + 10;
                var y_pos = Math.round(data.points[0].bbox["y0"]) - 10;
                // Setting chapter text
                var chapter_text = "";
                if (customdata["Start Chapter"] == customdata["End Chapter"])
                {
                    chapter_text = "Chapter " + customdata["Start Chapter"].toString();
                }
                else
                {
                    chapter_text = "Chapters " + customdata["Start Chapter"].toString() + " - " + customdata["End Chapter"].toString();
                }
                
                // Set date text 
                var date_text = ""
                if (customdata["Start Date"] == customdata["End Date"])
                {
                    var start = new Date(customdata["Total Start"]);
                    var current = new Date(customdata['Start Date']);
                    var difference = ((current - start) / (1000 * 3600 * 24));
                    date_text = "Day " + difference;
                }
                else
                {
                    var journeyStart = new Date(customdata["Total Start"]);
                    var countryStart = new Date(customdata['Start Date']);
                    var countryEnd = new Date(customdata['End Date']);
                    var startDay = ((countryStart - journeyStart) / (1000 * 3600 * 24));
                    var endDay = ((countryEnd - journeyStart) / (1000 * 3600 * 24));
                    date_text = "Days " + startDay + " - " + endDay;
                }
                

                var div = document.createElement("div");
                div.id = "hovertext"
                console.log(x_pos, y_pos);
                //div.style.width = "100px";
                //div.style.height = "100px";
                div.style.background = finalColor;
                div.style.color = "black";
                div.style.fontFamily = "Open Sans,sans-serif";

                var header = document.createElement("h2");
                header.innerText = chapter_text;
                div.appendChild(header);

                var date = document.createElement("p");
                date.innerText = customdata["Country"] + ": " + date_text;
                div.appendChild(date);

                // Set image
                console.log(customdata["Image Path"]);
                var image = document.createElement("img");
                image.src = customdata["Image Path"];
                var aspectRatio = customdata["Aspect Ratio"];
                var width = 256;
                var height = Math.round(width * aspectRatio);
                image.setAttribute("height", height);
                image.setAttribute("width", width);
                div.appendChild(image)

                //div.innerHTML = "Hello";
                
                div.style.position = "absolute";
                div.style.left = x_pos+'px';
                div.style.top = y_pos+'px';
                const currentDiv = document.getElementById("text");
                document.body.insertBefore(div, currentDiv);
            }
            
        }
    });

    fig.on('plotly_unhover', function(data){
        var element = document.getElementById("hovertext");
        if (typeof(element) != 'undefined' && element != null)
        {
            element.remove();
        }
        
    });



    fig.on('plotly_relayout', function(eventdata){ 
        handleZoomEvent(eventdata);
    });

    
    
</script>
<p id="text">And here's some text after the graph.</p>
</body>
</html>